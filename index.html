<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat App</title>
    <style>
        #local-video {
            width: 45%;
            border: 1px solid black;
            margin: 10px;
        }
        #remote-videos {
            display: flex;
            flex-wrap: wrap;
        }
        video {
            width: 45%;
            margin: 10px;
            border: 1px solid black;
        }
        #messages {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>P2P Chat App</h1>
    
    <div>
        <h2>Your Peer ID: <span id="peer-id"></span></h2>
        <button onclick="startConnection()">Start Connection</button>
        <input type="text" id="peer-id-input" placeholder="Enter peer ID to connect" />
    </div>
    
    <div id="local-video-container">
        <video id="local-video" autoplay muted></video>
    </div>

    <div id="remote-videos"></div>

    <div id="messages">
        <h3>Messages:</h3>
        <div id="message-log"></div>
        <input type="text" id="message" placeholder="Type a message..." />
        <button id="send-message">Send Message</button>
    </div>

    <script src="https://cdn.peerjs.com/peerjs.min.js"></script>
    <script>
        // Initialize PeerJS peer object
        const peer = new Peer();
        const messagesDiv = document.getElementById('message-log');
        const messageInput = document.getElementById('message');
        const sendButton = document.getElementById('send-message');
        const peerIdDisplay = document.getElementById('peer-id');
        const localVideo = document.getElementById('local-video');
        const remoteVideosContainer = document.getElementById('remote-videos');
        
        // Display the peer ID on the page
        peer.on('open', (id) => {
            peerIdDisplay.textContent = id;
        });

        // When a peer connects
        peer.on('connection', (conn) => {
            console.log('Connected to peer: ' + conn.peer);

            // Handle incoming messages
            conn.on('data', (data) => {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = `Peer: ${data}`;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });

            // Send message to peer
            sendButton.addEventListener('click', () => {
                const message = messageInput.value;
                if (message && conn.open) {
                    conn.send(message);
                    const messageDiv = document.createElement('div');
                    messageDiv.textContent = `Me: ${message}`;
                    messagesDiv.appendChild(messageDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    messageInput.value = '';  // Clear input
                }
            });
        });

        // Handle receiving the video stream
        peer.on('call', (call) => {
            call.answer(localStream); // Answer the call with the local stream

            call.on('stream', (remoteStream) => {
                const remoteVideo = document.createElement('video');
                remoteVideo.srcObject = remoteStream;
                remoteVideo.autoplay = true;
                remoteVideosContainer.appendChild(remoteVideo);
            });
        });

        // Get local media (camera and microphone)
        let localStream;
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localStream = stream;
                localVideo.srcObject = stream;
            })
            .catch((err) => {
                console.error('Error accessing media devices.', err);
            });

        // Connect to another peer
        function startConnection() {
            const peerId = document.getElementById('peer-id-input').value;
            if (peerId) {
                const conn = peer.connect(peerId);  // Connect to peer

                conn.on('open', () => {
                    console.log('Connected to peer: ' + peerId);
                });

                conn.on('data', (data) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.textContent = `Peer: ${data}`;
                    messagesDiv.appendChild(messageDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });

                // Initiate the video call
                const call = peer.call(peerId, localStream);
                call.on('stream', (remoteStream) => {
                    const remoteVideo = document.createElement('video');
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.autoplay = true;
                    remoteVideosContainer.appendChild(remoteVideo);
                });
            }
        }
    </script>
</body>
</html>
