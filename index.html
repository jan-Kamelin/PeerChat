<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PeerJS P2P Chat</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #peer-id { font-weight: bold; color: darkblue; }
    #messages { border: 1px solid #aaa; height: 200px; overflow-y: auto; padding: .5rem; }
    #messages div { margin-bottom: .5rem; }
    #controls { margin-top: 1rem; }
    #controls input { width: 200px; }
  </style>
</head>
<body>
  <h1>P2P Chat</h1>
  <p>Your Peer ID: <span id="peer-id">Loading…</span></p>

  <div id="messages"></div>

  <div id="controls">
    <input type="text" id="peer-id-input" placeholder="Peer ID to connect" />
    <button id="connect">Connect</button>
    <br/><br/>
    <input type="text" id="message" placeholder="Type your message…" />
    <button id="send" disabled>Send</button>
  </div>

  <script src="https://cdn.peerjs.com/peerjs.min.js"></script>
  <script>
    // 1) Create PeerJS peer on the public PeerJS server
    const peer = new Peer(undefined, {
      host: '0.peerjs.com',
      port: 443,
      secure: true
    });

    const peerIdDisplay = document.getElementById('peer-id');
    const peerInput     = document.getElementById('peer-id-input');
    const connectBtn    = document.getElementById('connect');
    const messagesDiv   = document.getElementById('messages');
    const messageInput  = document.getElementById('message');
    const sendBtn       = document.getElementById('send');

    let conn;  // will hold the DataConnection

    // Utility to append a message
    function appendMessage(sender, text) {
      const d = document.createElement('div');
      d.textContent = `${sender}: ${text}`;
      messagesDiv.appendChild(d);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 2) Show our Peer ID when ready
    peer.on('open', id => {
      peerIdDisplay.textContent = id;
    });

    // 3) Handle incoming connections
    peer.on('connection', c => {
      conn = c;
      setupConnection();
    });

    // 4) When user clicks “Connect”
    connectBtn.onclick = () => {
      const otherId = peerInput.value.trim();
      if (!otherId) return alert('Enter a Peer ID to connect');
      conn = peer.connect(otherId);
      conn.on('open', setupConnection);
    };

    // 5) Once DataConnection is open, enable sending
    function setupConnection() {
      sendBtn.disabled = false;
      conn.on('data', data => appendMessage('Peer', data));
      conn.on('close', () => {
        appendMessage('System', 'Connection closed');
        sendBtn.disabled = true;
      });
      appendMessage('System', 'Connected!');
    }

    // 6) Send messages
    sendBtn.onclick = () => {
      const msg = messageInput.value.trim();
      if (!msg || !conn || conn.open === false) return;
      conn.send(msg);
      appendMessage('Me', msg);
      messageInput.value = '';
    };

    // 7) Handle errors
    peer.on('error', err => {
      console.error(err);
      alert('PeerJS error: ' + err);
    });
  </script>
</body>
</html>
