<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeerChat - Group Chat & Video Call</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #messages {
      max-height: 200px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }

    #video-call {
      margin-top: 20px;
    }

    video {
      width: 200px;
      height: 150px;
      margin: 10px;
    }

    .container {
      display: flex;
      flex-direction: column;
    }

    .video-container {
      display: flex;
      flex-wrap: wrap;
    }

    #group-id, #message {
      width: 300px;
      padding: 5px;
      margin: 5px;
    }

    button {
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .group-chat-container {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>

  <h1>Welcome to PeerChat</h1>

  <!-- Group Chat -->
  <div class="group-chat-container">
    <h2>Group Chat</h2>
    <input type="text" id="group-id" placeholder="Enter Group ID" />
    <button onclick="connectToGroup(document.getElementById('group-id').value)">Join Group</button>

    <div id="group-chat">
      <div id="messages"></div>
      <input type="text" id="message" placeholder="Type a message" />
      <button onclick="sendGroupMessage(document.getElementById('message').value)">Send Message</button>
    </div>
  </div>

  <!-- Group Video Call -->
  <div id="video-call">
    <h2>Group Video Call</h2>
    <button onclick="startGroupVideoCall(document.getElementById('group-id').value)">Start Video Call</button>
    <button onclick="endGroupCall()">End Call</button>

    <div id="video-container" class="video-container"></div>
  </div>

  <!-- PeerJS library -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <script>
    // Initialize PeerJS
    const peer = new Peer(undefined, { host: 'localhost', port: 9000, path: '/peerjs' });

    let groupConnections = [];
    let groupCallPeers = [];
    let localStream = null;

    // Create a list to store group connections
    const messages = document.getElementById('messages');
    const videoContainer = document.getElementById('video-container');

    // Function to handle connecting to a group by its ID
    function connectToGroup(groupId) {
      const conn = peer.connect(groupId);
      conn.on("open", () => {
        groupConnections.push(conn);
        console.log("Connected to group:", groupId);
      });
      conn.on("data", (data) => {
        addMessage(data.peer, data.message);
      });
    }

    // Function to send a message to all peers in the group
    function sendGroupMessage(message) {
      groupConnections.forEach((conn) => {
        if (conn.open) {
          conn.send({ peer: peer.id, message: message });
        }
      });
    }

    // Add message to the chat box
    function addMessage(sender, message) {
      const msg = document.createElement("div");
      msg.textContent = `${sender}: ${message}`;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    // Function to start the group video call
    function startGroupVideoCall(groupId) {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(localMediaStream => {
          localStream = localMediaStream;
          // Display the local stream
          const localVideo = document.createElement("video");
          localVideo.srcObject = localMediaStream;
          localVideo.autoplay = true;
          localVideo.muted = true;
          videoContainer.appendChild(localVideo);

          // Call each peer in the group and send the local stream
          groupConnections.forEach(peerConn => {
            const call = peer.call(peerConn.peer, localMediaStream);
            groupCallPeers.push(call);

            call.on("stream", (remoteStream) => {
              // Create a new video element for each remote peer
              const remoteVideo = document.createElement("video");
              remoteVideo.srcObject = remoteStream;
              remoteVideo.autoplay = true;
              videoContainer.appendChild(remoteVideo);
            });

            call.on("close", () => {
              // Remove the video element when the call closes
              remoteVideo.remove();
            });
          });
        })
        .catch(err => console.error("Error starting video call: ", err));
    }

    // Function to end the group video call
    function endGroupCall() {
      groupCallPeers.forEach(call => call.close());

      // Stop the local stream and remove video elements
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }

      // Clear all video elements
      videoContainer.innerHTML = '';
    }

    // Event to listen for incoming connections
    peer.on("connection", (conn) => {
      conn.on("data", (data) => {
        addMessage(data.peer, data.message);
      });
    });

    // Handle incoming video call requests
    peer.on("call", (call) => {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(localMediaStream => {
          localStream = localMediaStream;
          call.answer(localMediaStream);

          call.on("stream", (remoteStream) => {
            // Create a new video element for each remote peer
            const remoteVideo = document.createElement("video");
            remoteVideo.srcObject = remoteStream;
            remoteVideo.autoplay = true;
            videoContainer.appendChild(remoteVideo);
          });

          call.on("close", () => {
            remoteVideo.remove();
          });
        });
    });
  </script>
</body>
</html>
